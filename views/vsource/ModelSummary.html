{% import "path/filepath" %}
{% import "github.com/kyleu/admini/app" %}
{% import "github.com/kyleu/admini/app/controller/cutil" %}
{% import "github.com/kyleu/admini/app/model" %}
{% import "github.com/kyleu/admini/app/util" %}
{% import "github.com/kyleu/admini/views/components" %}
{% import "github.com/kyleu/admini/views/components/fieldview" %}

{%- func ModelSummary(schemaKey string, idx int, model *model.Model, as *app.State, ps *cutil.PageState) -%}
  <li>
    <input id="model-list-{%d idx %}" type="checkbox" hidden />
    <label for="model-list-{%d idx %}">
      <em class="right">{%s model.Pkg.ToPath() %}</em>
      {%= components.ExpandCollapse(3, ps) %}
      {%= components.SVGRef(model.Type.Icon, 16, 16, `icon`, ps) %}{%s model.Name() %}
    </label>
    <div class="bd">
      <div>
        <a href="/s/{%s schemaKey %}/{%s filepath.Join(model.Path()...) %}"><button type="button">View</button></a>
      </div>

      <ul class="accordion">
        <li>
          <input id="{%s model.String() %}-fields" type="checkbox" hidden />
          <label for="{%s model.String() %}-fields">{%= components.ExpandCollapse(3, ps) %} {%s util.Plural(len(model.Fields), `field`, `fields`) %}</label>
          <div class="bd">
            {% if len(model.Fields) == 0 %}
            <div>No fields in {%s model.Type.String() %}</div>
            {% else %}
            <table>
              <thead>
                <tr>
                  <th>Key</th>
                  <th>Type</th>
                  <th title="nullable">âˆ…</th>
                  <th title="read-only">RO</th>
                  <th>Metadata</th>
                </tr>
              </thead>
              <tbody>
              {% for _, f := range model.Fields %}
                <tr>
                  <td>{%= fieldview.String(f.Key) %}</td>
                  <td>{%= fieldview.Type(f.Type) %}</td>
                  <td>{%= fieldview.Boolean(f.Nullable()) %}</td>
                  <td>{%= fieldview.Boolean(f.ReadOnly) %}</td>
                  <td><div class="pre">{%s util.ToJSON(f.Metadata) %}</div></td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
            {% endif %}
          </div>
        </li>
        <li>
          <input id="{%s model.String() %}-indexes" type="checkbox" hidden />
          <label for="{%s model.String() %}-indexes">{%= components.ExpandCollapse(3, ps) %} {%s util.Plural(len(model.Indexes), `index`, `indexes`) %}</label>
          <div class="bd">
            {% if len(model.Indexes) == 0 %}
            <div>No indexes in {%s model.Type.String() %}</div>
            {% else %}
            <table>
              <thead>
                <tr>
                  <th>Key</th>
                  <th>Fields</th>
                  <th>Unique</th>
                  <th title="Primary Key">PK</th>
                </tr>
              </thead>
              <tbody>
              {% for _, idx := range model.Indexes %}
                <tr>
                  <td>{%= fieldview.String(idx.Key) %}</td>
                  <td>{%= fieldview.ArrayString(idx.Fields) %}</td>
                  <td>{%= fieldview.Boolean(idx.Unique) %}</td>
                  <td>{%= fieldview.Boolean(idx.Primary) %}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
            {% endif %}
          </div>
        </li>
        <li>
          <input id="{%s model.String() %}-relations" type="checkbox" hidden />
          <label for="{%s model.String() %}-relations">{%= components.ExpandCollapse(3, ps) %} {%s util.Plural(len(model.Relationships), `relationship`, `relationships`) %}</label>
          <div class="bd">
            {% if len(model.Relationships) == 0 %}
            <div>No relationships in {%s model.Type.String() %}</div>
            {% else %}
            <table>
              <thead>
                <tr>
                  <th>Key</th>
                  <th>Fields</th>
                  <th>Target Package</th>
                  <th>Target Model</th>
                  <th>Target Fields</th>
                </tr>
              </thead>
              <tbody>
              {% for _, rel := range model.Relationships %}
                <tr>
                  <td>{%= fieldview.String(rel.Key) %}</td>
                  <td>{%= fieldview.ArrayString(rel.SourceFields) %}</td>
                  <td>{%= fieldview.Package(rel.TargetPkg) %}</td>
                  <td>{%= fieldview.String(rel.TargetModel) %}</td>
                  <td>{%= fieldview.ArrayString(rel.TargetFields) %}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
            {% endif %}
          </div>
        </li>
        <li>
          <input id="{%s model.String() %}-references" type="checkbox" hidden />
          <label for="{%s model.String() %}-references">{%= components.ExpandCollapse(3, ps) %} {%s util.Plural(len(model.References), `reference`, `references`) %}</label>
          <div class="bd">
            {% if len(model.References) == 0 %}
            <div>No references in {%s model.Type.String() %}</div>
            {% else %}
            <table>
              <thead>
                <tr>
                  <th>Key</th>
                  <th>Fields</th>
                  <th>Source Package</th>
                  <th>Source Model</th>
                  <th>Source Fields</th>
                </tr>
              </thead>
              <tbody>
              {% for _, ref := range model.References %}
                <tr>
                  <td>{%= fieldview.String(ref.Key) %}</td>
                  <td>{%= fieldview.ArrayString(ref.TargetFields) %}</td>
                  <td>{%= fieldview.Package(ref.SourcePkg) %}</td>
                  <td>{%= fieldview.String(ref.SourceModel) %}</td>
                  <td>{%= fieldview.ArrayString(ref.SourceFields) %}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
            {% endif %}
          </div>
        </li>
      </ul>
    </div>
  </li>
{%- endfunc -%}
