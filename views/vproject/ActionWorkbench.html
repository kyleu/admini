{% import "fmt" %}
{% import "github.com/kyleu/admini/app" %}
{% import "github.com/kyleu/admini/app/controller/cutil" %}
{% import "github.com/kyleu/admini/app/model" %}
{% import "github.com/kyleu/admini/app/project" %}
{% import "github.com/kyleu/admini/app/project/action" %}
{% import "github.com/kyleu/admini/app/schema" %}
{% import "github.com/kyleu/admini/app/source" %}
{% import "github.com/kyleu/admini/views/layout" %}
{% import "github.com/kyleu/admini/views/vutil" %}

{% code type ActionWorkbench struct {
  layout.Basic
  View *project.View
} %}

{% func (p *ActionWorkbench) Body(as *app.State, ps *cutil.PageState) %}
  <div class="drag-container">
    <div class="action-workbench">
      <div class="l">
        <div class="drag-actions right no-changes">
          <div class="message"><em>no changes</em></div>
          <div class="form">
            <form action="" method="post">
              <input type="hidden" class="drag-state-original" value=""/>
              <input type="hidden" class="drag-state" value="" name="ordering"/>
              <button type="submit">Save</button>
            </form>
          </div>
        </div>
        <h3 class="no-padding"><span class="drag-tracked-size">{%d p.View.Project.Actions.Size() %}</span> Actions</h3>
        <div class="clear"></div>
        <div class="container tracked">
          {%- for _, act := range p.View.Project.Actions -%}
          {%= ActionList(p.View.Project.Key, act, as, ps, 5) %}
          {%- endfor -%}
        </div>
      </div>
      <div class="r">
        <h3 class="no-padding">Available</h3>
        <div class="container">
          {%= itemTemplate(action.TypeFolder, `folder`, `New Folder`, 5) %}
          {%= itemTemplate(action.TypeAll, `all`, `All Sources`, 5) %}
          {%- for _, src := range p.View.Sources -%}
          {%= itemSchema(src, p.View.Schemata.Get(src.Key), 5) %}
          {%- endfor -%}
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript" src="/assets/sortable.js"></script>
{% endfunc %}

{% func itemSchema(src *source.Source, sch *schema.Schema, indent int) %}{% stripspace %}
  {%= itemTemplate(action.TypeSource, `source/` + src.Key, src.Name(), 5) %}
  {%= itemTemplate(action.TypeActivity, `activity/` + src.Key + "/sql", "SQL Playground", 5) %}
  {%= itemModelPackage(src, sch.ModelsByPackage(), false, 5) %}
{% endstripspace %}{% endfunc %}

{% func itemModelPackage(src *source.Source, pkg *model.Package, showRoot bool, indent int) %}{% stripspace %}
  {% if showRoot %}
    {%= itemTemplate(action.TypePackage, fmt.Sprintf("package/%v/%v", src.Key, pkg.PathString()), pkg.Key, indent) %}
  {% endif %}
  {% for _, p := range pkg.ChildPackages %}
    {%= vutil.Indent(true, indent) %}
    {%= itemModelPackage(src, p, true, indent) %}
  {% endfor %}
  {% for _, m := range pkg.ChildModels %}
    {%= vutil.Indent(true, indent) %}
    {%= itemTemplate(action.TypeModel, fmt.Sprintf("model/%v/%v", src.Key, m.PathString()), m.Name(), indent) %}
  {% endfor %}
{% endstripspace %}{% endfunc %}

{% func itemTemplate(t action.Type, path string, title string, indent int) %}{% stripspace %}
<div class="item{% space %}{%s t.Key %}" data-key="_new" data-original-path="{%s path %}">
  {%= vutil.Indent(true, indent + 1) %}
  <div class="content">
    {%= vutil.Indent(true, indent + 2) %}
    <div class="handle">≡</div>
    {%= vutil.Indent(true, indent + 2) %}
    <div class="title">{%s title %}</div>
    {%= vutil.Indent(true, indent + 2) %}
    <div class="remove">×</div>
  {%= vutil.Indent(true, indent + 1) %}
  </div>
  {%= vutil.Indent(true, indent + 1) %}
  <div class="container"></div>
{%= vutil.Indent(true, indent) %}
</div>
{% endstripspace %}{% endfunc %}

{% func ActionList(prj string, act *action.Action, as *app.State, ps *cutil.PageState, indent int) %}{% stripspace %}
  <div class="item" data-key="{%s act.Key %}" data-original-path="{%s act.Pkg.ToPath(act.Key) %}">
    {%= vutil.Indent(true, indent + 1) %}
    <div class="content">
      {%= vutil.Indent(true, indent + 2) %}
      <div class="handle">≡</div>
      {%= vutil.Indent(true, indent + 2) %}
      <div class="title"><a href="{%s as.Route(`action.edit`, `key`, prj) %}/{%s act.Pkg.ToPath(act.Key) %}">{%s act.Name() %}</a></div>
      {%= vutil.Indent(true, indent + 2) %}
      <div class="remove">×</div>
      {%= vutil.Indent(true, indent + 1) %}
    </div>
    {%= vutil.Indent(true, indent + 1) %}
    {% if len(act.Children) == 0 %}
      <div class="container"></div>
    {% else %}
      <div class="container">
        {% for _, kid := range act.Children %}
          {%= vutil.Indent(true, indent + 2) %}
          {%= ActionList(prj, kid, as, ps, indent + 2) %}
        {% endfor %}
      {%= vutil.Indent(true, indent + 1) %}
      </div>
    {% endif %}
  {%= vutil.Indent(true, indent) %}
  </div>
{% endstripspace %}{% endfunc %}
