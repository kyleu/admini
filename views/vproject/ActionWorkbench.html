{% import "fmt" %}
{% import "github.com/kyleu/admini/app" %}
{% import "github.com/kyleu/admini/app/controller/cutil" %}
{% import "github.com/kyleu/admini/app/project" %}
{% import "github.com/kyleu/admini/app/project/action" %}
{% import "github.com/kyleu/admini/views/layout" %}
{% import "github.com/kyleu/admini/views/vaction" %}
{% import "github.com/kyleu/admini/views/vutil" %}

{% code type ActionWorkbench struct {
  layout.Basic
  View *project.View
} %}

{% func (p *ActionWorkbench) Body(as *app.State, ps *cutil.PageState) %}
<div class="card">
  <h3>{%s p.View.Project.Name() %} Workbench</h3>
  <div class="drag-container">
    <div class="action-workbench">
      <div class="l">
        <h4 class="no-padding">Actions</h4>
        <div class="container tracked">
          {%- for _, act := range p.View.Project.Actions -%}
          {%= vaction.List(p.View.Project.Key, act, as, ps, 4) %}
          {%- endfor -%}
        </div>
      </div>
      <div class="r">
        <h4 class="no-padding">Available</h4>
        <div class="container lmdd-dispatcher">
          {%= itemTemplate(action.TypeFolder, `folder`, `New Folder`, 5) %}
          {%= itemTemplate(action.TypeAll, `all`, `All Sources`, 5) %}
          {%- for _, src := range p.View.Sources -%}
          {%= itemTemplate(action.TypeSource, `source/` + src.Key, src.Name(), 5) %}
          {%- code sch := p.View.Schemata.Get(src.Key) -%}
          {%- for _, m := range sch.Models -%}
          {%= itemTemplate(action.TypeModel, fmt.Sprintf("model/%v/%v", src.Key, m.PathString()), m.Name(), 5) %}
          {%- endfor -%}
          {%- endfor -%}
        </div>
      </div>
    </div>
    <div class="actions hidden">
      <form action="" method="post">
        <input type="hidden" class="drag-state-original" value=""/>
        <input type="hidden" class="drag-state" value="" name="ordering"/>
        <button type="submit">Save</button>
      </form>
    </div>
  </div>
</div>
<script type="text/javascript" src="/assets/dragdrop.js"></script>
{% endfunc %}

{% func itemTemplate(t action.Type, path string, title string, indent int) %}{% stripspace %}
<div class="item{% space %}{%s t.Key %}{% space %}lmdd-clonner" data-key="_new" data-original-path="{%s path %}">
  {%= vutil.Indent(true, indent + 1) %}
  <div class="content">
    {%= vutil.Indent(true, indent + 2) %}
    <div class="handle">â‰¡</div>
    {%= vutil.Indent(true, indent + 2) %}
    <div class="title">{%s title %}</div>
    {%= vutil.Indent(true, indent + 2) %}
    <div class="remove">&times;</div>
  {%= vutil.Indent(true, indent + 1) %}
  </div>
  {%= vutil.Indent(true, indent + 1) %}
  <div class="container"></div>
{%= vutil.Indent(true, indent) %}
</div>
{% endstripspace %}{% endfunc %}
